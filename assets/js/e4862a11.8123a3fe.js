"use strict";(self.webpackChunklunat_1_c=self.webpackChunklunat_1_c||[]).push([[8783],{7664:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>o,metadata:()=>i,toc:()=>d});var t=s(5893),r=s(1151);const o={title:"",sidebar_label:"Collections"},a=void 0,i={id:"records/Query/Query",title:"",description:"No.1 \u62bd\u53d6RequestBody\uff0cResponseBody\uff0cVin\uff08\u672aBase64\u52a0\u5bc6\u7684\u60c5\u51b5\uff09",source:"@site/docs/records/Query/Query.md",sourceDirName:"records/Query",slug:"/records/Query/",permalink:"/lunat1c/docs/records/Query/",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/records/Query/Query.md",tags:[],version:"current",frontMatter:{title:"",sidebar_label:"Collections"},sidebar:"records",previous:{title:"KqlQuery",permalink:"/lunat1c/docs/category/kqlquery"},next:{title:"runBlogWeb",permalink:"/lunat1c/docs/records/HowToStartUOwnBlogWeb"}},c={},d=[{value:"No.1 \u62bd\u53d6RequestBody\uff0cResponseBody\uff0cVin\uff08\u672aBase64\u52a0\u5bc6\u7684\u60c5\u51b5\uff09",id:"no1-\u62bd\u53d6requestbodyresponsebodyvin\u672abase64\u52a0\u5bc6\u7684\u60c5\u51b5",level:3},{value:"No.2 \u62bd\u53d6RequestBody\uff0cResponseBody\uff0cVin\uff08Base64\u52a0\u5bc6\u7684\u60c5\u51b5\uff09",id:"no2-\u62bd\u53d6requestbodyresponsebodyvinbase64\u52a0\u5bc6\u7684\u60c5\u51b5",level:3},{value:"No.3 \u62bd\u53d6RequestBody\uff0cResponseBody\uff0cSql\uff08Base64\u52a0\u5bc6\u7684\u60c5\u51b52\uff09",id:"no3-\u62bd\u53d6requestbodyresponsebodysqlbase64\u52a0\u5bc6\u7684\u60c5\u51b52",level:3},{value:"No.4 TransactionID\u7ed3\u5408",id:"no4-transactionid\u7ed3\u5408",level:3},{value:"No.5 \u30b5\u30fc\u30d3\u30b9\u9045\u5ef6\u72b6\u6cc1\u307e\u3068\u3081",id:"no5-\u30b5\u30fc\u30d3\u30b9\u9045\u5ef6\u72b6\u6cc1\u307e\u3068\u3081",level:3},{value:"No.6 \u62bdVinCounts",id:"no6-\u62bdvincounts",level:3}];function m(e){const n={blockquote:"blockquote",code:"code",h3:"h3",p:"p",pre:"pre",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h3,{id:"no1-\u62bd\u53d6requestbodyresponsebodyvin\u672abase64\u52a0\u5bc6\u7684\u60c5\u51b5",children:"No.1 \u62bd\u53d6RequestBody\uff0cResponseBody\uff0cVin\uff08\u672aBase64\u52a0\u5bc6\u7684\u60c5\u51b5\uff09"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u23ed","  log\u4e2d\u8bf7\u6c42\u548c\u54cd\u5e94\u672aBase64\u52a0\u5bc6\u7684\u60c5\u51b5\uff0c\u76f4\u63a5\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u62bd\u53d6\u5185\u5bb9"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"| extend requestBody = extract('\\\\[RequestBody](.*?)\\\\[ResponseBody]', 1, message, typeof(string))\r\n| extend responseBody = extract('[[]ResponseBody[]]({.*})', 1, message, typeof(string))\r\n| extend Vin = extractjson('$.Vin', requestBody)\r\n//| extend Vin = parse_json(Request).vin\n"})}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.h3,{id:"no2-\u62bd\u53d6requestbodyresponsebodyvinbase64\u52a0\u5bc6\u7684\u60c5\u51b5",children:"No.2 \u62bd\u53d6RequestBody\uff0cResponseBody\uff0cVin\uff08Base64\u52a0\u5bc6\u7684\u60c5\u51b5\uff09"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u23ed"," log\u4e2d\u8bf7\u6c42\u548c\u54cd\u5e94\u88abBase64\u52a0\u5bc6\u7684\u60c5\u51b5\uff0c\u5148\u6b63\u5219\u8868\u8fbe\u5f0f\u62bd\u51fa\u52a0\u5bc6\u7684\u5185\u5bb9\uff0c\u518d\u89e3\u5bc6"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"| extend base64_RequestBody = extract('RequestBody[]](.*)\\n', 1, message, typeof(string))\r\n| extend RequestBody = coalesce(base64_decode_tostring(base64_RequestBody),gzip_decompress_from_base64_string(base64_RequestBody))\r\n| extend base64_ResponseBody = extract('ResponseBody[]](.*)\\n', 1, message, typeof(string))\r\n| extend ResponseBody = coalesce(base64_decode_tostring(base64_ResponseBody),gzip_decompress_from_base64_string(base64_ResponseBody)) \r\n| extend Vin = extractjson('$.Vin', RequestBody)\n"})}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.h3,{id:"no3-\u62bd\u53d6requestbodyresponsebodysqlbase64\u52a0\u5bc6\u7684\u60c5\u51b52",children:"No.3 \u62bd\u53d6RequestBody\uff0cResponseBody\uff0cSql\uff08Base64\u52a0\u5bc6\u7684\u60c5\u51b52\uff09"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u23ed"," log\u4e2d\u8bf7\u6c42\u548c\u54cd\u5e94\u88abBase64\u52a0\u5bc6\u7684\u60c5\u51b5\uff0c\u5148\u6b63\u5219\u8868\u8fbe\u5f0f\u62bd\u51fa\u52a0\u5bc6\u7684\u5185\u5bb9\uff0c\u518d\u4f7f\u7528\u591a\u79cd\u65b9\u5f0f\u89e3\u6790Body"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"let GetRequest = (message: string) {\r\n    let base64_body = extract('[[]RequestBody[]](.*)', 1, message);\r\n    let body = coalesce(base64_decode_tostring(base64_body)\r\n                      , gzip_decompress_from_base64_string(base64_body)\r\n                      , extract('[[]RequestBody[]]:(.*?),[[]ResponseHeader[]]', 1, message)\r\n                      , extract('[[]RequestBody[]](.*?),[[]ResponseBody[]]', 1, message)\r\n                      , extract('[[]RequestBody[]](.*?)[[]ResponseBody[]]', 1, message)\r\n                      , extract('[[]RequestBody[]](.*?),[[]Message[]]', 1, message)\r\n                      , extract('[[]RequestBody[]](.*?)[[]Message[]]', 1, message)\r\n                      , extract('[[]RequestBody[]](.*?),[[]ResponseHeaders[]]', 1, message)\r\n                      , extract('[[]RequestBody[]](.*?)[[]ResponseHeaders[]]', 1, message)\r\n                       );\r\n    iif(message has 'Start' and isempty(body), extract('[Bb]ody:(.*)', 1, message), body);\r\n};\r\nlet GetResponse = (message: string) {\r\n    let base64_body = extract('[[]ResponseBody[]](.*)', 1, message);\r\n    let body = coalesce(base64_decode_tostring(base64_body)\r\n                      , gzip_decompress_from_base64_string(base64_body)\r\n                      , extract('[[]ResponseBody[]]:(.*?),[[]Method[]]', 1, message)\r\n                      , extract('[[]ResponseBody[]](.*?),[[]Message[]]', 1, message)\r\n                      , extract('[[]ResponseBody[]](.*?)[[]Message[]]', 1, message)\r\n                      , extract('[[]ResponseBody[]](.*?),[[]ResponseHeaders[]]', 1, message)\r\n                      , extract('[[]ResponseBody[]](.*?)[[]ResponseHeaders[]]', 1, message)\r\n                       );\r\n    iif(message has 'End' and isempty(body), extract('[Bb]ody:(.*)', 1, message), body);\r\n};\r\nlet GetSql = (message: string) {\r\n    extract('[[]SQL[]](.*)', 1, message)\r\n};\r\n//\u63d0\u53d6\u591a\u4e2a\u4fe1\u606f\r\n| extend Request = GetRequest(message)\r\n| extend Response = GetResponse(message)\r\n| extend errorID = customDimensions.errorID\r\n| extend resultCode = extractjson('$.resultCode', GetResponse(message))\r\n| extend MethodName = extract('[[]MethodName[]](.*)' , 1, message)\r\n| extend serviceName = customDimensions.serviceName\r\n| extend msg = extract('[[]Message[]](.*)', 1, message)\r\n| extend strSql = GetSql(message)\n"})}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.h3,{id:"no4-transactionid\u7ed3\u5408",children:"No.4 TransactionID\u7ed3\u5408"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u23ed"," \u90e8\u5206\u8bed\u53e5\uff0c\u6839\u636eTransactionID\u8fdb\u884c\u7ed3\u5408\uff0c\u67e5\u8be2\u591a\u4e2a\u64cd\u4f5c\u7684log"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"let RecieveResultTranId = traces\r\n| where operation_Name == 'POST ReceiveCooperationResult/RecieveCooperationResult'\r\n| where message has _vin\r\n| extend transactionID = tostring(customDimensions.transactionID)\r\n| distinct transactionID;\r\nlet CooperationBatchTranId = traces\r\n| where customDimensions.serviceName == 'CooperationBatch'\r\n| where message has _vin\r\n| extend transactionID = tostring(customDimensions.transactionID)\r\n| distinct transactionID;\r\n//.......\r\n| where customDimensions.transactionID in ((union RecieveResultTranId, CooperationBatchTranId | project transactionID))\n"})}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.h3,{id:"no5-\u30b5\u30fc\u30d3\u30b9\u9045\u5ef6\u72b6\u6cc1\u307e\u3068\u3081",children:"No.5 \u30b5\u30fc\u30d3\u30b9\u9045\u5ef6\u72b6\u6cc1\u307e\u3068\u3081"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u23ed"," \u5b8c\u5168query\uff0c\u53ef\u76f4\u63a5\u4f7f\u7528\uff0c\u6ce8\u610f\u66f4\u6539region\u548c\u65f6\u95f4"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"let startDatetime = datetime(2024-08-02T02:04:14Z);\r\nlet endDatetime = datetime(2024-08-02T04:04:14Z);\r\nlet collectionPeriod = 1h;// \u53ce\u96c6\u3059\u308b\u30ed\u30b0\u306e\u7d42\u7aef\u6642\u523b\u3002endDateTime\u3088\u308a\u3082\u591a\u3081\u306b\u53d6\u308a\u3064\u3064\u3001\u8ca0\u8377\u304c\u304b\u304b\u3089\u306a\u3044\u7a0b\u5ea6\u306e\u671f\u9593\u3092\u8a2d\u5b9a\u3059\u308b\u3053\u3068\u3002\r\nlet delayTime_short = 120s;\r\nlet delayTime_long = 120m;  // \u9045\u5ef6\u6642\u9593\r\nlet count_Alert = 0; // \u30ed\u30b9\u30c8\u4ef6\u6570\u95be\u5024\r\nlet OtherAppiLog = (union withsource=SourceApp\r\n    app('SI-JPP-APPLOG-20PF-APPI02').traces, // XXX: JPP,USO,EUP  //\u8ee2\u9001\u5148\u306b\u30ed\u30b0\u304c\u3042\u308b\u304b\u78ba\u8a8d  \r\n    app('SI-JPP-APPLOG-20PF-APPI03').traces\r\n| where timestamp between (startDatetime .. (endDatetime + collectionPeriod))\r\n| where customDimensions .errorID == \"000C01\"\r\n| extend TransactionID = tostring(customDimensions.transactionID)\r\n| summarize max(timestamp) by TransactionID\r\n);\r\n//let NoFileConverter = pack_array(''); // \u5909\u63db\u51e6\u7406\u304c\u306a\u3044\u6a5f\u80fd\u3092\u9664\u5916\u3057\u306a\u3044  \r\n//let NoFileConverter = pack_array('/v1/accident','/v1/ffd','/v1/last','/v1/mcr','/v1/ofn','/v1/oneTimePass/request/','/v1/dre/rDiagResult','/v1/all-diag/errornotification','/v1/dre/HelpNet','/v2/ffd','/v2/last','/v2/mcr','/v2/ofn','/v2/dre/rDiagResult','/v2/all-diag/errornotification','/v2/oneTimePass/request/'); // (20PFMNAO)\u5909\u63db\u51e6\u7406\u304c\u306a\u3044\u6a5f\u80fd\u3092\u9664\u5916  \r\nlet NoFileConverter = pack_array('/v1/accident','/v1/ffd','/v1/last','/v1/mcr','/v1/ofn','/v1/oneTimePass/request/','/v1/dre/rDiagResult','/v1/all-diag/errornotification','/v1/dre/HelpNet','/v2/ffd','/v2/last','/v2/ofn','/v2/dre/rDiagResult','/v2/all-diag/errornotification','/v2/oneTimePass/request/'); // (20PFMJO)\u5909\u63db\u51e6\u7406\u304c\u306a\u3044\u6a5f\u80fd\u3092\u9664\u5916  \r\n//let NoFileConverter = pack_array('/v2/ffd','/v2/last','/v2/dre/rDiagResult','/v2/ofn','/v2/mcr','/v2/all-diag/errornotification','/v2/oneTimePass/request/'); // (20PFMME)\u5909\u63db\u51e6\u7406\u304c\u306a\u3044\u6a5f\u80fd\u3092\u9664\u5916  \r\ntraces\r\n| where timestamp between (startDatetime .. endDatetime)\r\n| where customDimensions .serviceName == \"AsyncReceiver\"\r\n| where not( customDimensions .URL has_any (NoFileConverter))\r\n| extend TransactionID = tostring(customDimensions.transactionID)\r\n| extend URL = extract('[0-9]+\\\\.[0-9]+\\\\.[0-9]+\\\\.[0-9]+(:[0-9]+)?(.*)', 2 , tostring(customDimensions.URL), typeof(string))\r\n| summarize min(timestamp), max(timestamp), arg_min(timestamp, URL) by TransactionID\r\n| join kind=leftouter (traces\r\n| where timestamp between (startDatetime .. (endDatetime + collectionPeriod))\r\n| where customDimensions .serviceName == \"FileConverter\"\r\n| extend TransactionID = tostring(customDimensions.transactionID)\r\n| summarize min(timestamp), max(timestamp) by TransactionID\r\n) on TransactionID\r\n| join kind=leftouter (traces\r\n| where timestamp between (startDatetime .. (endDatetime + collectionPeriod))\r\n| where customDimensions .serviceName == \"Transfer\"\r\n| extend TransactionID = tostring(customDimensions.transactionID)\r\n| summarize max(timestamp) by TransactionID\r\n) on TransactionID\r\n| join kind=leftouter (OtherAppiLog) on TransactionID\r\n| extend executionTime = iif(isnotempty( min_timestamp1), min_timestamp1 - max_timestamp, totimespan(\"00:00\"))\r\n| summarize [\"\u30ea\u30af\u30a8\u30b9\u30c8\u5168\u4f53\u6570 [\u4ef6]\"] = count(), [\"\u9045\u5ef6\u4ef6\u6570(2\u5206\u4ee5\u4e0a) [\u4ef6]\"] = countif(executionTime >= delayTime_short), [\"\u9045\u5ef6\u4ef6\u6570(120\u5206\u4ee5\u4e0a) [\u4ef6]\"] = countif(executionTime >= delayTime_long), [\"\u6700\u5927\u9045\u5ef6\u6642\u9593\"] = max(executionTime), [\"\u5931\u6557\u6570 [\u4ef6]\"] = countif(isempty( TransactionID1) and isempty( TransactionID2) and isempty( TransactionID3))\r\n, [\"\u9045\u5ef6\u958b\u59cb\u6642\u523b(2\u5206\u4ee5\u4e0a)\"] = minif( timestamp, executionTime >= delayTime_short), [\"\u9045\u5ef6\u7d42\u4e86\u6642\u523b(2\u5206\u4ee5\u4e0a)\"] = maxif( timestamp, executionTime >= delayTime_short)\r\n, [\"\u9045\u5ef6\u958b\u59cb\u6642\u523b(120\u5206\u4ee5\u4e0a)\"] = minif( timestamp, executionTime >= delayTime_long), [\"\u9045\u5ef6\u7d42\u4e86\u6642\u523b(120\u5206\u4ee5\u4e0a)\"] = maxif( timestamp, executionTime >= delayTime_long)\r\n, [\"\u30ed\u30b9\u30c8\u958b\u59cb\u6642\u523b\"] = minif( timestamp, isempty( TransactionID1) and isempty( TransactionID2) and isempty( TransactionID3)), [\"\u30ed\u30b9\u30c8\u7d42\u4e86\u6642\u523b\"] = maxif( timestamp, isempty( TransactionID1) and isempty( TransactionID2) and isempty( TransactionID3)) by URL\r\n| sort by URL asc\n"})}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.h3,{id:"no6-\u62bdvincounts",children:"No.6 \u62bdVinCounts"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u23ed"," \u90e8\u5206\u8bed\u53e5\uff0c\u901a\u8fc7\u5206\u522b\u7684summarize\uff0c\u518d\u7ed3\u5408\u8d77\u6765\uff0c\u62bd\u51faVin\u6570"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"_Base\r\n| summarize RequestCounts = count() by ServiceRank, Region, ServiceName, RequestResult\r\n| join kind = inner (\r\n    _Base\r\n    | summarize count() by ServiceRank, Region, ServiceName, RequestResult, Vin\r\n    | summarize VinCounts = count() by ServiceRank, Region, ServiceName, RequestResult\r\n    )\r\n    on ServiceRank, Region, ServiceName, RequestResult\n"})})]})}function l(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(m,{...e})}):m(e)}},1151:(e,n,s)=>{s.d(n,{Z:()=>i,a:()=>a});var t=s(7294);const r={},o=t.createContext(r);function a(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);